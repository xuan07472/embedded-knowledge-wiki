# 嵌入式私有自定义通信协议  

|作者|将狼才鲸|
|---|---|
|创建日期|2022-05-03|

## 一、首先介绍一个开源的简单的通信解析  
* uTP协议，μTP (Micro Transport Protocol)，也称之为BitTorrent uTorrent Transport Protocol。  
* uTP协议比TCP协议简单，方便魔改成自己的协议；uTP基于UDP，但却是一个可靠的通讯协议；原本用于BitTorrent上的P2P连接。  
* 我们可以直接将uTP用于自己的设备通信。  

* C语言源码网址（C语言和C++混合编程）：  
[Gitee mirrors_bittorrent / libutp](https://gitee.com/mirrors_bittorrent/libutp)  
[GitHub源码路径](https://github.com/bittorrent/libutp)  

* uTP官网网址：  
[libtorrent.org/utp](https://www.libtorrent.org/utp.html)  
[uTorrent Transport Protocol](http://www.bittorrent.org/beps/bep_0029.html)  

* 其它文档网址：  
[BT协议学习笔记4--uTP](https://blog.csdn.net/chen_jianjian/article/details/103772447)  
[uTP协议的前世今生（from wikipedia）](https://blog.csdn.net/shahongzhou/article/details/6638207)  
[uTP协议的封装信息](https://blog.csdn.net/shahongzhou/article/details/6636947)  
[uTorrent如何在TCP和uTP之间进行选择？](http://cn.voidcc.com/question/p-tdxuesxh-bhm.html)  
[uTorrent的传输协议之BT-uTP](https://blog.csdn.net/ReversalC/article/details/8182049)  
[什么是 uTP 协议，为什么它如此重要？](https://itigic.com/what-is-utp-protocol-and-why-is-it-so-important/)  
[Utp Protocol In Networking](https://terraincounts.s3-ap-southeast-2.amazonaws.com/utp-protocol-in-networking.pdf)  
[libutp源码简析](https://blog.csdn.net/CoderAldrich/article/details/80583411)  
[BitTorrent官网](http://www.bittorrent.org/)  
[BitTorrent 简介](https://blog.csdn.net/riba2534/article/details/115602512)  

## 二、uTP协议详解  
* 完整的uTP协议包含阻塞控制、数据窗口大小、延迟测量、ACK。  
* 序列号和ACK是针对整个数据包，而不是数据字节内容，所以传输失败时会重发整个数据包。  
* 有丢包和超时机制：数据包的最小超时为1/2秒；最小的数据包大小是150 字节。  

### 1）数据格式（单位是bit）：  

|4|4|8+N|16|32|32|32|16|16|
|---|---|---|---|---|---|---|---|---|
|类型|版本号|扩展数据|连接id|时间戳|时间戳延时|窗口大小|发送序列号|响应序列号|

1. 类型：  

|缩写|ST_DATA|ST_FIN|ST_STATE|ST_RESET|ST_SYN|
|---|---|---|---|---|---|
|描述|常规数据包|完成连接|状态数据包|强制终止连接|启动连接|
|备注|套接字处于连接状态时要发送的数据|最后一个数据包并且关闭连接|传输没有数据的ACK||序列号初始化为1，连接ID初始化为随机数|

SYN --> STATE --> DATA --> FIN  

2. 扩展数据：扩展数据指示扩展的类型，0代表没有扩展，如果有扩展的话后面会再额外插入2字节长度，然后是具体长度的扩展数据。  
   其中扩展数据可以是ACK响应，可以用至少32bits非顺序地对至少32个数据包进行ACK响应。  
   仅当接收的流中跳过至少一个序列号时，才会发送选择性ACK。  
3. 连接id：一个随机的数字，每个连接的发送端和接收端都有一个不同的“连接id”。  
4. 时间戳：微秒，发送数据时的真实时间。  
5. 时间戳延时：这是本地时间与上次接收的数据包（接收最后一个数据包时）的时间戳差异；用于延迟测量。  
6. 窗口大小：窗口大小是当前正在传输的字节数。  
7. 发送/响应序列号：指数据包的序列号，告诉另一端应以何种顺序将数据包发给上层；响应时是上一次收到的序列号。  


## 三、铁塔B协议  
* 铁塔B协议文档更清晰，可自行上网搜索文档，铁塔协议各家实现的源码都不一样，实现的过程中一般都有路由、转发、子设备这些。  

## 四、私有自定义协议（Self Transmission Protocol）  
* 支持的通信设备子模块有：内存拷贝、以太网MAC层、串口、USB、CAN等。  
* 单对单通信，暂未加入路由机制。  
* 数据包格式：  
CID: 连接时分配随机值  
LEN: 数据长度  
SID: 连接时分配随机值  
TYPE: STP_TYPE协议类型  
SEC: SEC_UG等权限操作：urgency紧急、administrator管理员、operator操作员、normal_user终端用户  
PID: 数据包类型、ACK响应包
SUB  
CRC: 可选，在不可靠物理层上才使用，如果是内存拷贝或者基于TCP就用不到  

有超时和重发机制  

## 五、源码介绍  

